#!/bin/bash
# ─────────────────────────────────────────────────
# winvx-setup — WinVX Hotkey Configuration Tool
# Auto-detect desktop environment, check for hotkey conflicts, bind hotkeys
#
# Usage:
#   winvx-setup              # Interactive mode
#   winvx-setup --auto       # Auto-select the first available hotkey
#   winvx-setup --remove     # Remove bound WinVX hotkeys
# ─────────────────────────────────────────────────

set -e

WINVX_CMD="python3 /opt/winvx/main.py --toggle"
WINVX_NAME="WinVX Clipboard"

# Candidate hotkeys (priority order)
CANDIDATES=("Super+V" "Super+B" "Super+G" "Super+H" "Super+J" "Super+K")
# gsettings format mapping
declare -A GS_MAP=(
    ["Super+V"]="<Super>v"
    ["Super+B"]="<Super>b"
    ["Super+G"]="<Super>g"
    ["Super+H"]="<Super>h"
    ["Super+J"]="<Super>j"
    ["Super+K"]="<Super>k"
)

# ── Color Output ────────────────────────────────────

GREEN="\033[32m"
YELLOW="\033[33m"
RED="\033[31m"
CYAN="\033[36m"
BOLD="\033[1m"
RESET="\033[0m"

info()  { echo -e "${GREEN}✓${RESET} $1"; }
# info()  { echo -e "${GREEN}✓${RESET} $1"; }
warn()  { echo -e "${YELLOW}⚠${RESET} $1"; }
error() { echo -e "${RED}✗${RESET} $1"; }
title() { echo -e "\n${BOLD}${CYAN}$1${RESET}"; }

# ── Desktop Environment Detection ────────────────────────

detect_desktop() {
    local desktop="${XDG_CURRENT_DESKTOP:-}"
    desktop=$(echo "$desktop" | tr '[:upper:]' '[:lower:]')

    if echo "$desktop" | grep -qE "gnome|ubuntu|unity|pop"; then
        echo "gnome"
    elif echo "$desktop" | grep -qE "kde|plasma"; then
        echo "kde"
    elif echo "$desktop" | grep -qE "xfce"; then
        echo "xfce"
    elif echo "$desktop" | grep -qE "cinnamon"; then
        echo "cinnamon"
    elif echo "$desktop" | grep -qE "mate"; then
        echo "mate"
    elif echo "$desktop" | grep -qE "budgie"; then
        echo "budgie"
    else
        echo "unknown"
    fi
}

desktop_display_name() {
    case "$1" in
        gnome)    echo "GNOME" ;;
        kde)      echo "KDE Plasma" ;;
        xfce)     echo "XFCE" ;;
        cinnamon) echo "Cinnamon" ;;
        mate)     echo "MATE" ;;
        budgie)   echo "Budgie" ;;
        *)        echo "Unknown ($XDG_CURRENT_DESKTOP)" ;;
    esac
}

# ── GNOME Hotkey Detection ───────────────────────────

gnome_is_key_used() {
    # $1 = gsettings format, e.g., "<Super>v"
    local target="$1"

    # 1. Check built-in hotkeys (media-keys etc.)
    local schemas=(
        "org.gnome.settings-daemon.plugins.media-keys"
        "org.gnome.desktop.wm.keybindings"
        "org.gnome.shell.keybindings"
        "org.gnome.mutter.keybindings"
    )

    for schema in "${schemas[@]}"; do
        # List all keys under this schema
        local keys
        keys=$(gsettings list-keys "$schema" 2>/dev/null) || continue
        while IFS= read -r key; do
            local val
            val=$(gsettings get "$schema" "$key" 2>/dev/null) || continue
            # Ignore empty values
            [[ "$val" == "@as []" || "$val" == "''" || "$val" == "['']" ]] && continue
            # Check if it contains target hotkey (case-insensitive)
            if echo "$val" | grep -qi "$(echo "$target" | sed 's/[<>]/./g')"; then
                echo "$schema $key"
                return 0
            fi
        done <<< "$keys"
    done

    # 2. Check custom hotkeys
    local custom_list
    custom_list=$(gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings 2>/dev/null) || return 1
    # Parse path list
    local paths
    paths=$(echo "$custom_list" | grep -oP "'/[^']+'" | tr -d "'" 2>/dev/null) || return 1
    while IFS= read -r path; do
        [[ -z "$path" ]] && continue
        local binding
        binding=$(gsettings get "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:${path}" binding 2>/dev/null) || continue
        if echo "$binding" | grep -qi "$(echo "$target" | sed 's/[<>]/./g')"; then
            local name
            name=$(gsettings get "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:${path}" name 2>/dev/null)
            # If it is registered by WinVX itself, it is not a conflict
            if echo "$name" | grep -qi "winvx"; then
                return 1
            fi
            echo "Custom Hotkey $name"
            return 0
        fi
    done <<< "$paths"

    return 1
}

gnome_bind_key() {
    # $1 = gsettings format
    local binding="$1"
    local base="org.gnome.settings-daemon.plugins.media-keys"
    local path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/winvx/"
    local schema="org.gnome.settings-daemon.plugins.media-keys.custom-keybinding"

    # Read existing list
    local existing
    existing=$(gsettings get "$base" custom-keybindings 2>/dev/null) || existing="@as []"

    # Add path (if not exists)
    if ! echo "$existing" | grep -q "winvx"; then
        if [[ "$existing" == "@as []" || "$existing" == "[]" ]]; then
            local new_list="['${path}']"
        else
            local new_list="${existing%]}, '${path}']"
        fi
        gsettings set "$base" custom-keybindings "$new_list"
    fi

    # Set hotkey properties
    gsettings set "${schema}:${path}" name "$WINVX_NAME"
    gsettings set "${schema}:${path}" command "$WINVX_CMD"
    gsettings set "${schema}:${path}" binding "$binding"
}

gnome_remove_key() {
    local base="org.gnome.settings-daemon.plugins.media-keys"
    local path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/winvx/"

    local existing
    existing=$(gsettings get "$base" custom-keybindings 2>/dev/null) || return 0

    if echo "$existing" | grep -q "winvx"; then
        local new_list
        new_list=$(echo "$existing" \
            | sed "s|, *'${path}'||g" \
            | sed "s|'${path}', *||g" \
            | sed "s|'${path}'||g")
        gsettings set "$base" custom-keybindings "$new_list" 2>/dev/null || true
        # Clear hotkey properties
        gsettings reset "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:${path}" name 2>/dev/null || true
        gsettings reset "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:${path}" command 2>/dev/null || true
        gsettings reset "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:${path}" binding 2>/dev/null || true
    fi
}

# ── KDE Hotkey Detection ─────────────────────────────

kde_is_key_used() {
    local target="$1"  # e.g. "Super+V" → "Meta+V"
    local kde_key="${target//Super/Meta}"
    local rc="$HOME/.config/kglobalshortcutsrc"
    [[ -f "$rc" ]] || return 1

    if grep -qi "$kde_key" "$rc" 2>/dev/null; then
        local match
        match=$(grep -i "$kde_key" "$rc" | head -1)
        echo "KDE Hotkey: $match"
        return 0
    fi
    return 1
}

kde_bind_key() {
    local target="$1"
    local kde_key="${target//Super/Meta}"
    kwriteconfig5 --file kglobalshortcutsrc \
        --group "winvx.desktop" \
        --key "_launch" "${WINVX_CMD},none,${WINVX_NAME}"
    # Refresh
    dbus-send --type=signal --dest=org.kde.KGlobalAccel \
        /component/winvx org.kde.kglobalaccel.Component.changed 2>/dev/null || true
}

kde_remove_key() {
    kwriteconfig5 --file kglobalshortcutsrc \
        --group "winvx.desktop" --key "_launch" --delete 2>/dev/null || true
}

# ── XFCE Hotkey Detection ────────────────────────────

xfce_is_key_used() {
    local target="$1"  # "Super+V" → "<Super>v"
    local xfce_key="${GS_MAP[$target]}"
    if command -v xfconf-query &>/dev/null; then
        local bindings
        bindings=$(xfconf-query -c xfce4-keyboard-shortcuts -l -v 2>/dev/null) || return 1
        if echo "$bindings" | grep -qi "$xfce_key"; then
            echo "XFCE Hotkey"
            return 0
        fi
    fi
    return 1
}

xfce_bind_key() {
    local xfce_key="${GS_MAP[$1]}"
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/${xfce_key}" \
        -n -t string -s "$WINVX_CMD" 2>/dev/null || true
}

xfce_remove_key() {
    local xfce_key="${GS_MAP[$1]}"
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/${xfce_key}" \
        -r 2>/dev/null || true
}

# ── Generic: Cinnamon / MATE / Budgie (based on gsettings) ──

generic_bind_key() {
    gnome_bind_key "$1"
}

generic_is_key_used() {
    gnome_is_key_used "$1"
}

generic_remove_key() {
    gnome_remove_key
}

# ── Core Logic ───────────────────────────────────────

check_key() {
    # Check if candidate key is occupied, returns 0=occupied, 1=available
    local key="$1"
    local gs_key="${GS_MAP[$key]}"

    case "$DESKTOP" in
        gnome|budgie|cinnamon|mate)
            gnome_is_key_used "$gs_key" && return 0
            ;;
        kde)
            kde_is_key_used "$key" && return 0
            ;;
        xfce)
            xfce_is_key_used "$key" && return 0
            ;;
    esac
    return 1
}

bind_key() {
    local key="$1"
    local gs_key="${GS_MAP[$key]}"

    case "$DESKTOP" in
        gnome|budgie|cinnamon|mate)
            gnome_bind_key "$gs_key"
            ;;
        kde)
            kde_bind_key "$key"
            ;;
        xfce)
            xfce_bind_key "$key"
            ;;
        *)
            error "Unsupported desktop environment for automatic binding"
            echo ""
            echo "Please manually set the hotkey:"
            echo "  Command: $WINVX_CMD"
            echo "  Hotkey: $key"
            return 1
            ;;
    esac
}

remove_key() {
    case "$DESKTOP" in
        gnome|budgie|cinnamon|mate) gnome_remove_key ;;
        kde)   kde_remove_key ;;
        xfce)  xfce_remove_key "$1" ;;
    esac
}

# ── Main Flow ────────────────────────────────────────

do_setup() {
    local auto_mode="$1"

    title "WinVX Hotkey Configuration"

    # 1. Detect desktop environment
    DESKTOP=$(detect_desktop)
    local display_name
    display_name=$(desktop_display_name "$DESKTOP")
    info "Desktop Environment: ${BOLD}${display_name}${RESET}"

    # 2. Check dependencies
    if [[ "$DESKTOP" == "gnome" || "$DESKTOP" == "budgie" || "$DESKTOP" == "cinnamon" || "$DESKTOP" == "mate" ]]; then
        if ! command -v gsettings &>/dev/null; then
            error "gsettings is not available"
            return 1
        fi
    fi

    # 3. Check candidate hotkeys
    title "Checking Hotkey Availability"

    local available=()
    local occupied=()

    for key in "${CANDIDATES[@]}"; do
        local conflict
        if conflict=$(check_key "$key" 2>/dev/null); then
            occupied+=("$key")
            warn "${key} — Occupied ($conflict)"
        else
            available+=("$key")
            info "${key} — Available"
        fi
    done

    if [[ ${#available[@]} -eq 0 ]]; then
        error "All candidate hotkeys are occupied!"
        echo ""
        echo "Please manually add a custom hotkey in system settings:"
        echo "  Command: $WINVX_CMD"
        return 1
    fi

    # 4. Select hotkey
    local chosen=""

    if [[ "${available[0]}" == "Super+V" ]]; then
        # Super+V is available, use it directly
        chosen="Super+V"
        info "Using default hotkey: ${BOLD}${chosen}${RESET}"
    elif [[ "$auto_mode" == "true" ]]; then
        # Automatic mode: select the first available one
        chosen="${available[0]}"
        warn "Super+V is occupied, auto-selecting: ${BOLD}${chosen}${RESET}"
    else
        # Interactive mode: let user choose
        echo ""
        title "Please select a hotkey"
        local i=1
        for key in "${available[@]}"; do
            echo "  ${CYAN}${i})${RESET} ${key}"
            ((i++))
        done
        echo ""
        read -r -p "Please input choice number [1]: " choice
        choice=${choice:-1}

        if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#available[@]} )); then
            chosen="${available[$((choice-1))]}"
        else
            chosen="${available[0]}"
        fi
    fi

    # 5. Bind hotkey
    title "Binding Hotkey"

    # Remove old WinVX binding first
    remove_key "$chosen" 2>/dev/null || true

    if bind_key "$chosen"; then
        info "Bound: ${BOLD}${chosen}${RESET} → WinVX"
    else
        return 1
    fi

    echo ""
    echo -e "${GREEN}${BOLD}✅ Configuration complete!${RESET}"
    echo ""
    echo "  Press ${BOLD}${chosen}${RESET} to open clipboard history"
    echo "  Start command: winvx"
    echo "  Reconfigure: winvx-setup"
    echo ""
}

do_remove() {
    title "Removing WinVX Hotkey"
    DESKTOP=$(detect_desktop)
    remove_key "Super+V"
    info "Removed WinVX hotkey binding"
}

# ── Entry ────────────────────────────────────────────

case "${1:-}" in
    --auto)
        do_setup "true"
        ;;
    --remove)
        do_remove
        ;;
    --help|-h)
        echo "Usage: winvx-setup [options]"
        echo ""
        echo "Options:"
        echo "  (none)     Interactive mode, let user choose hotkey"
        echo "  --auto     Auto-select the first available hotkey"
        echo "  --remove   Remove WinVX hotkey binding"
        echo "  --help     Show help"
        ;;
    *)
        do_setup "false"
        ;;
esac
